from PIL import Image
import numpy as np
import WaveletTransform.TwoDWaveletTransformer as wt2d
import Tree.TwoDimBesovForest as tbf
from tqdm import tqdm
import matplotlib.pyplot as plt

def calcMSE(img1, img2):
    return np.mean((img1 - img2) ** 2)

def calcPSNR(original_img, recon_img):
    peak = original_img.max()
    mse = calcMSE(original_img, recon_img)
    return 10 * np.log10(peak**2 / mse)

def psnrAnalysis(real_img_path, noisy_img_path, beta_values, wavelet, mode, levels):
    real_img = np.asarray(Image.open(real_img_path).convert("L"))
    noisy_img = Image.open(noisy_img_path).convert("L")
    normed_noisy_img = np.asarray(noisy_img)/255

    hsm, wt = wt2d.get2DWaveletCoefficients(normed_noisy_img, wavelet, mode)
    psnrs = []
    for beta in tqdm(beta_values):
        forest = tbf.TwoDimBesovForest(wt, beta, max_level=levels[1], start_level=levels[0])
        new_coeffs = forest.getMinimizingPosteriorCoefficients()
        new_img = wt2d.inverse2DDWT([hsm, new_coeffs], wavelet, mode)*255
        psnr = calcPSNR(real_img, new_img)
        psnrs.append(psnr)
    return psnrs

def psnrAnalysisMultipleFiles(real_img_path, noisy_img_paths, beta_values, wavelet, mode, levels):
    dct = {}
    for noisy_img_path in tqdm(noisy_img_paths):
        psnrs = psnrAnalysis(real_img_path, noisy_img_path, beta_values, wavelet, mode, levels)
        dct[noisy_img_path] = psnrs
    return dct



if __name__ == "__main__":
    # lena_noisy_imgs_test = ["../Lena/Lena512_noi_s5.png", "../Lena/Lena512_noi_s10.png", "../Lena/Lena512_noi_s15.png", "../Lena/Lena512_noi_s20.png"]
    # lena_noisy_imgs = ["../Lena/Lena512_noi_s5.png", "../Lena/Lena512_noi_s10.png", "../Lena/Lena512_noi_s15.png", "../Lena/Lena512_noi_s20.png",
    #              "../Lena/Lena512_noi_s25.png", "../Lena/Lena512_noi_s30.png", "../Lena/Lena512_noi_s35.png", "../Lena/Lena512_noi_s40.png",
    #              "../Lena/Lena512_noi_s50.png", "../Lena/Lena512_noi_s60.png", "../Lena/Lena512_noi_s70.png", "../Lena/Lena512_noi_s80.png",
    #              "../Lena/Lena512_noi_s90.png", "../Lena/Lena512_noi_s100.png"]
    beta_values = [0.1,0.2,0.3,0.35, 0.4, 0.425, 0.45, 0.49, 0.499, 0.4999, 0.49999, 0.51]
    # wavelet = "db2"
    # mode = "per"
    # levels = [0, 6]
    # res = psnrAnalysisMultipleFiles("../Lena/Lena512.png",lena_noisy_imgs, beta_values, wavelet, mode, levels)
    # print(res)
    haar = { "s5": [19.173744311366633, 20.02670787792089, 20.79291429798939, 21.31015467346353, 21.871738281488323, 22.274869139145054, 23.165533025538394, 26.18949105385646, 31.414281741670358, 34.772717361158236, 33.806514989071296, 33.792326263591065],"s10": [19.173281861868592, 20.015486586263137, 20.774457735290852, 21.307897281019255, 21.877710566952487, 22.270751568278516, 23.192491059338977, 26.15208875192199, 30.713274468311596, 27.99253368105065, 27.78555205651095, 27.784586597765276],"s15": [19.17250741172606, 20.071411252804587, 20.771888255296147, 21.30415036984973, 21.876596292454032, 22.27510895584567, 23.1612410139762, 26.103239936937502, 28.21602964862594, 24.31306327077678, 24.26849130152915, 24.268325644008165],"s20": [19.192523909004045, 20.079334056542407, 20.775261224841447, 21.30911496115655, 21.881479470515835, 22.28121020985759, 23.113854491472644, 26.005032733531067, 23.78964422062122, 21.802825879886445, 21.789748129818896, 21.78969250300552],"s25": [19.191135065489988, 20.052722051399492, 20.737621413072244, 21.28094426626943, 21.87725215116778, 22.28050419822494, 23.10842434294021, 25.87328960623793, 20.753670975872353, 19.895504686650387, 19.89078331737052, 19.890765688236844],"s30": [19.18923196161098, 20.088166502613184, 20.709727916220224, 21.202251919702224, 21.872208515514835, 22.27231041376584, 23.09064206986553, 25.690712074296833, 18.77673439920566, 18.36493273776968, 18.362690830808187, 18.362686225762722],"s35": [19.17178225376909, 20.028076959674877, 20.701918990286945, 21.184300996991794, 21.823561227164593, 22.213920824807065, 23.02004329147911, 25.38153815681258, 17.31679281388692, 17.09269488284032, 17.091609760323156, 17.09160977091897],"s40": [19.167115621396558, 20.020677761433987, 20.67048909743623, 21.17282160278377, 21.724891659220354, 22.19753752554738, 22.968496466452986, 24.834149051906692, 16.146263748102555, 16.013900351879933, 16.01332713260825, 16.013326983816555],"s50": [19.077410578472552, 19.77748329394159, 20.555599661997466, 21.028995057163588, 21.590324606374843, 22.043583101952482, 22.79441808454567, 22.33382367263344, 14.32947891641654, 14.274980519234328, 14.274728999419462, 14.274729396394875],"s60": [19.006696892362047, 19.598224665386248, 20.414076124073834, 20.863133454373447, 21.447915893957365, 21.852330965936012, 22.52562963301697, 18.330797248448828, 12.968073567219493, 12.940943705126218, 12.940803520871258, 12.940802215734852],"s70": [18.885583255775444, 19.34259493162226, 20.247872172890673, 20.616449697642288, 21.181330250690987, 21.600023279382, 22.16639814493595, 15.127871134041273, 11.906209249176953, 11.890852967209511, 11.890745750516745, 11.890745060545404],"s80": [18.70088275454253, 19.15774359617017, 20.021681402795096, 20.35420580373701, 20.894849105847175, 21.287455763635037, 21.744482377194085, 13.079175520804194, 11.063988701846641, 11.053732417134079, 11.053653079179231, 11.053651035307867],"s90": [18.50993560095501, 18.837987650954258, 19.666393356948504, 19.99084341951106, 20.56197986904767, 20.90502697889014, 21.306913345277838, 11.748441884721139, 10.383576876847588, 10.376117532987465, 10.376033271085445, 10.376033801535744],"s100": [18.228866265294332, 18.653367909333763, 19.31797745080456, 19.692499131052482, 20.18267914926668, 20.49001101877657, 20.84460588664808, 10.806923754815394, 9.825675444754884, 9.819852155822481, 9.819778458812173, 9.819777310316148]}
    db2 = {"s5": [19.585160202796416, 20.347484281770612, 21.22530140991868, 21.792488523224726, 22.454986607678737, 22.864073709831935, 23.574476414906478, 26.938132180456122, 32.2231282978283, 35.037872230121565, 33.807142323634636, 33.792326263591065], "s10": [19.584514965610612, 20.335405197736335, 21.22114488822564, 21.76809916384363, 22.456196695044667, 22.866639503215623, 23.567810406792262, 26.898821450693248, 31.45689726766626, 28.007830812209086, 27.78566423659045, 27.784586597765276], "s15": [19.533625434231126, 20.345422119361857, 21.22519365728084, 21.789262559847206, 22.44334869656904, 22.842766878255482, 23.559143433113988, 26.811195483863482, 28.67183553609474, 24.314607927854365, 24.268465063658653, 24.268325644008165], "s20": [19.53219017450721, 20.3429604421261, 21.228024467987275, 21.78131859068504, 22.431903578262116, 22.838024589495326, 23.58370522418347, 26.714349065441247, 23.962758334179636, 21.803167209008013, 21.789757529084184, 21.78969250300552], "s25": [19.530335705841342, 20.293009130393447, 21.232105308462927, 21.781029431102837, 22.416221961038442, 22.804521698477025, 23.539919233482742, 26.5966275495013, 20.810549393849822, 19.89602959379065, 19.890786159981065, 19.890765688236844], "s30": [19.50881663556681, 20.288921376480154, 21.199519825766565, 21.75773453402511, 22.39726612279108, 22.819471755036066, 23.506046574220633, 26.374429911775014, 18.79507583040255, 18.364864898359325, 18.362695068552956, 18.362686225762722], "s35": [19.433907511032807, 20.28312186553183, 21.189808610988997, 21.714727502993373, 22.36788553536404, 22.824048570176643, 23.433577558133017, 26.01245280440663, 17.324616171482653, 17.092721892218492, 17.091613832763997, 17.09160977091897], "s40": [19.381504131878053, 20.250047803486414, 21.145874683301958, 21.685958794567778, 22.33509547818577, 22.747022842507164, 23.370107404829273, 25.389087749996374, 16.149014441542334, 16.01384785654901, 16.013327874281945, 16.013326983816555], "s50": [19.32122781388012, 20.139387448153524, 20.95362755638222, 21.555789786032975, 22.20690876039532, 22.61038513198067, 23.23233984523966, 22.58790723743814, 14.332812319791827, 14.274956869309692, 14.27473020803616, 14.274729396394875], "s60": [19.19525555492649, 19.991526635733322, 20.804671546179243, 21.33781946424164, 21.99192228953697, 22.39574922980664, 22.97084706110632, 18.37597421505561, 12.969646257421113, 12.940899533368654, 12.94080281671687, 12.940802215734852], "s70": [19.017545580886576, 19.83490346432651, 20.599306458882246, 21.007605369032667, 21.726995540955127, 22.129393466045908, 22.61035601449326, 15.184861102496743, 11.90729315148518, 11.890798873839843, 11.890745043405325, 11.890745060545406], "s80": [18.819112133050528, 19.559497110194137, 20.32297144059815, 20.730641579509776, 21.401950408372596, 21.74734529929919, 22.221353854116796, 13.141164843001551, 11.064095955022255, 11.053681746211314, 11.05365130247094, 11.053651035307867], "s90": [18.59147689709282, 19.16248227661254, 19.85773694227276, 20.361043565798393, 21.012585531732203, 21.344701633182343, 21.767856027003315, 11.817051290231081, 10.382910565417017, 10.376055540219944, 10.376033927864373, 10.376033801535744], "s100": [18.364030399354593, 18.867892476652138, 19.52465678725116, 19.974027699062393, 20.509252777951716, 20.890099889356073, 21.25584584437766, 10.881688182208757, 9.824755795443545, 9.819794278867079, 9.81977745718656, 9.819777310316148]}
    psnr_bm3d_vals = [38.72, 35.93, 34.27, 33.05, 32.08, 31.26, 30.56, 29.86, 29.05, 28.27, 27.57, 27.26, 26.97, 26.45,
                 25.95]

    fig, axs = plt.subplots(3,5, figsize=(30,15))
    fig.suptitle('PSNR of Lena for different noise levels', fontsize=16)

    for ax, key, psnr_bm3d_val in zip(axs.ravel(), haar, psnr_bm3d_vals):
        name = key
        haar_psnr = haar[key]
        db2_psnr = db2[key]
        ax.plot(beta_values, haar_psnr, label=f"Haar wavelet")
        ax.plot(beta_values, db2_psnr, label=f"Db2 wavelet")
        ax.plot(beta_values, [psnr_bm3d_val]*len(beta_values), label="BM3D PSNR")
        ax.set_xlabel("Beta")
        ax.set_ylabel("PSNR")
        ax.set_title(f"Noise level {name}")
        ax.legend()
    print('Donesor')
    fig.savefig("LenaComparison.png")